# setup rails on 1104ubuntu

do the rvm thing first.

Before you do `bundle` in happycasts/

do this for the gem "rails"

    sudo apt-get install zlib1g zlib1g-dev
    # not sure about if the follow 4 commands are necessary
    cd .rvm/src/ruby-1.9.2-p180/ext/zlib
    ruby extconf.rb
    make
    sudo make install

and this for mysql

    sudo apt-get install libmysqlclient-dev
    

and this for nokogiri

    apt-get install libxml2-dev libxslt1-dev

now done with the bundler.

    cd ~/ # we don't need to stay in happycasts/
    gem install passenger

now:
    passenger-install-apache2-module

still I need to install sevel pkgs suggested by passenger, all works for me except that openssl header still not found
and I see " libruby is installed instead of libopenssl-ruby" when I installing the suggested pkg, but it ended up that this is not a problem, the following fixed everything

    cd ~/.rvm/src/ruby-1.9.2-p290/ext/openssl/
    ruby extconf.rb 
    make
    make install


now setup the http.conf and /etc/hosts, I see

   can not connect to mysql  

so
    apt-get install mysql-server

now the error is:

    Unknown database 'happycasts_development'

and the final fix is

    rake db:create
    rake db:migrate

everything works




# new app

    rails new blog -d mysql
    rake doc:guides # need a burdle install here

then I followed the doc, and everything works well.

## db on 10.10-server and 10.04-desktop

    sudo apt-get install mysql-server # client and things are installed as deps
    sudo apt-get install phpmyadmin # php-cli and things are installed as deps

and now:

    root@lover:/etc/phpmyadmin# vim config.inc.php 

uncomment this line:

    $cfg['Servers'][$i]['AllowNoPassword'] = TRUE;

and add a link:

    peter@lover:/var/www$ ln -s /usr/share/phpmyadmin/

now point firefox at:

    http://happypeter.org/phpmyadmin/

you can login as root with no passwd

### connect mysql to rails

    sudo apt-get install libmysqlclient16 libmysqlclient16-dev

is needed for:

    sudo gem install mysql

in turn is needed to:

    rake db:create
    rake db:migrate 
## docs
#
you actually get a README in `myapp/`
and you run:

    rake doc:guides

you get nice html docs in `doc/`

These docs surely match the exe running.
This is important

## apache

    sudo gem install passenger
    # when dploying on lover, this step failed, so I add passenger to Gemfile,
    # and bundle update passenger, did the job, nice
    sudo passenger-install-apache2-module 
    sudo vim /etc/apache2/httpd.conf

and you difinitely need:

    peter@peter-Vostro:~/xxx/blog$ rake RAILS_ENV=production db:create
    (in /home/peter/xxx/blog)
    peter@peter-Vostro:~/xxx/blog$ rake RAILS_ENV=production db:migrate

now firefox www.whatever_in_etchosts_for_localhost.com works, but phpmyadmin no longer works
## Railscasts deployment

ERROR: Could not find eventmachine-0.12.10 in any of the sources


FIX:
sudo apt-get install libxml2-dev libxslt-dev g++ mysql-server  libmysqlclient-dev

ERROR: rake db:migrate failed

FIX: 

    iii sphinxsearch

    https://github.com/ryanb/railscasts/wiki/Deployment

now I check condif/database.yml, and now I know if u use development environment, mysql sock will be in /tmp/, but now in my mysql database, I have railscasts_production, so I know this will do:

    rake RAILS_ENV=production db:migrate

now all the tables in database: railscasts_production are successfully created.

but when I start rails server with:

    rails s

still in the browser I see the same error: can not connect .../tmp/sock.sql

and now I know I need to passenger and try to set all my env to: production.

    gem install passenger
    passenger-install-apache2-module # no sudo for both, but `cd railscasts/` is a must

    sudo vim /etc/apache2/http.conf

and add:

    LoadModule passenger_module /home/peter/.rvm/gems/ruby-1.9.2-p180@railscasts/gems/passenger-3.0.7/ext/apache2/mod_passenger.so
    PassengerRoot /home/peter/.rvm/gems/ruby-1.9.2-p180@railscasts/gems/passenger-3.0.7
    PassengerRuby /home/peter/.rvm/wrappers/ruby-1.9.2-p180@railscasts/ruby
    <VirtualHost *:80>
        ServerName www.lll.com
        DocumentRoot /home/peter/railscasts/public/
        RackEnv development
        <Directory /home/peter/railscasts/public>
           AllowOverride all
           Options -MultiViews
        </Directory>
    </VirtualHost>

the line "  RackEnv development" is necessary
now:

    sudo apachectl graceful

and now point firefox at 192.168.1.103(the ip of the very VM), works.

and now I go to add a feedback msg in the brower, and the msg goes to mysql without any error.

# setup rails onlinode( only a root user as default)

##DNS
nice doc: http://library.linode.com/dns-guides/introduction-to-dns

gotoz:
https://secure.domain.com/account/am/mydomains.php
click "happycasts.net" -> name servers -> click "update name server" -> now

http://library.linode.com/dns-guides/configuring-dns-with-the-linode-manager

add 

    ns1.linode.com
    ns2.linode.com
    ns3.linode.com
 
as the name server used by domain.com, so now when I visit "happycasts.net" it will go to domain.com, then domain.com will use the linode.com name server, thus all the records about DNS records are done on linode.com

add media.happycasts.net as a new A record, then I go for it in firefox at once, when firefox showed me a "address not found" page, I need to wait for some time obvious. but even a quarter hour passed, and the media.happycasts.net already works in safari, firefox still gives me the "not found" page.


now I have problem using "happyec.org" in IE, while I have no issue using "happycasts.net", so I go to linode, and add a empty AAAA record and try again, waiting .............???????????? while linode will update its own DNS server in 15 mins, but IE still can not access "happyec.org", it seems it will wait for 2 days until the "empty-hostname.happyec.org"(AKA, happyec.org) will be updated by main DNS servers. NO, it works, just three hours later, huriii!





# rvm command

NOTE: rvm was really nauty when I run it as root

follow the output

    adduser root rvm

then I need to install gcc:

    apt-get install gcc make
    
now install ruby

    rvm install 1.9.3
    rvm use 1.9.3 # without this, `ruby --version` shows me  ruby is not installed
    rvm --default use 1.9.3

now this error:

    root@li400-112:~# gem install rails
    ERROR:  Loading command: install (LoadError)
    cannot load such file -- zlib
    ERROR:  While executing gem ... (NameError)
    uninitialized constant Gem::Commands::InstallCommand

the fix is a old method( but that the ~/.rvm is now /usr/local/rvm, since the user is now root)

    sudo apt-get install zlib1g zlib1g-dev
    cd .rvm/src/ruby-1.9.2-p180/ext/zlib
    ruby extconf.rb
    make
    sudo make install

now

    gem install rails # I got 3.2.1 installed
    gem unintall rails
    gem install rails -v 3.0.7 # on lover verion

when Installing passenger

    openssl problem can not be fixed by the hint of passenger output only, need to plus this

        cd /usr/local/rvm/ruby-1.9.3/src/ext/openssl/
        ruby extconf.rb
        make
        sudo make install

when I run
        
    bundle

then I found I need to

    apt-get install libxml2-dev libxslt-dev

when passenger is ready, and I put happycasts/ in /root/
then I see "permission denied" in the brower, which is fixed when I `mv happycasts /var/www`

linode server login as root, but I want to login as peter as before, so I

    useradd peter #create a peter
    usermod -a -G admin peter # add peter as a sudoer

 now passenger again

    gem install passenger
    passenger-install-apache2-module 
    # no sudo above!!
    sudo vim /etc/apache2/httpd.conf

and in http.conf

    Railenv production 

cause a "we are sorry..." error page, when changed to development, it is ok then.
now everthing works as before. So all the "cancan can not checkout " problem is gone when I no longer login with root


### use passenger in a higher verion of ruby

 first install passenger in rvm-ruby=1.9.3(the new version), now paste the tree lines into /etc/apache2/http.conf( yes, replace the lines for 1.9.2, there is no way to use passenger for more than one version of ruby)

now I still need to run "rvm 1.9.3 --default", otherwise my websites will still try to use 2.9.2, and no one can go alive.

when I done with happyec.org, which is using 1.9.3 ruby, all my other sites using 1.9.2 will be started with this error: (Bundler::GemNotFound). I know the fix is simple go to the root of each project and run "bundle install" to install all the gems to 1.9.3, but then I mix all gems together, maybe nicer to use gemset.
# sqlite:

    sqlite> delete from posts where id=27;
    sqlite>.tables;

# reading:
http://www.neilkearney.net/welcome/2011/04/essential-ruby-rails-3-reading/
http://www.aidanf.net/rails_user_authentication_tutorial

## gem issue

ERROR: when running `gem install rails`, the error was 'no file to load -- zlib', the fix is:

    sudo apt-get install zlib1g zlib1g-dev 
    cd .rvm/src/ruby-1.9.2-p180/ext/zlib
    ruby extconf.rb
    make
    sudo make install

everything else works perfectly well.

NOTE: similar problem also happens to __openssl__ and __libreadline__,fixes go here: 
http://intertwingly.net/blog/2009/09/13/RVM-for-Ubuntu-Tip
http://cjohansen.no/en/ruby/ruby_version_manager_ubuntu_and_openssl

ERROR:

    ler::ExtensionBuildError)

            /home/peter/.rvm/rubies/ruby-1.9.2-p290/bin/ruby extconf.rb 
            checking for rb_thread_blocking_region()... yes
            checking for mysql_query() in -lmysqlclient... no

FIX:

    sudo apt-get install libmysqlclient-dev
## rake issue ( obsolete )
Error looks:

    'task' undefined

or:

    rails rake problems: uninitialized constant Rake::DSL 


this is a reported bug for rake 0.9, I fix this by downgrade it to 0.8.7

add this in to Gemfile:

    gem 'rake', '0.8.7'

and then `bundle update`, like suggested here:
http://stackoverflow.com/questions/5287121/undefined-method-task-using-rake-0-9-0/5290331#5290331

and then run this:

    gem uninstall rake -v 0.9.0


and this link is useful when you have to use 0.9:
http://stackoverflow.com/questions/6085610/rails-rake-problems-uninitialized-constant-rakedsl

# When I need a gemset
1.9.2@happyec
I think gemset is only needed when your gems have conflicts, say if two of your projects are all using 1.9.2 ruby, but in one project you want to use Redcarpet1.0, while in another you want Redcarpet2.0.
